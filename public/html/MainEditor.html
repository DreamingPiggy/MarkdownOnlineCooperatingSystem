<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Editor</title>
        <style>
            #toolBoxMiddle
            {
                height: 64px;
                
                box-shadow: 0 0 1px #DDDDDD;
                border-top: 1px solid #DDDDDD;
                border-left: 1px solid #DDDDDD;
                border-right: 1px solid #DDDDDD;
                border-bottom: 2px solid #4183C4;
                
                border-radius: 4px;
                
                margin-top: 8px;
                margin-bottom: 8px;
            }
            
            table#toolBoxTable
            {
                padding-top: 12px;
            }
            
            table#toolBoxTable td.Tool
            {
                width: 32px;
                height: 32px;
                
                padding-left: 16px;
                padding-right: 16px;
            }
            
            .ToolIcon
            {
                width: 32px;
                height: 32px;
                
                background-size: 32px, 32px;
                background-repeat: no-repeat;
            }
            
            #menu
            {
                width: 128px;
                min-height: 32px;
                
                margin-right: 8px;
                
                float: left;
            }
            
            #editorBody
            {
                width: 872px;
                
                float: right;
            }
            
            #editPannel
            {
                width: 432px;
                min-height: 32px;
                
                margin-right: 8px;
                
                border-right: 1px solid #DDDDDD;
                
                float: left;
            }
            
            #editPane
            {
                width: inherit;
                min-height: 32px;
                resize :none;
                
                text-align: left;
                border: none;
                
                font-family: Arial;
                
                overflow-y: hidden;
                overflow-x: hidden;
            }
            
            #liveView
            {
                width: 430px;
                min-height: 32px;
                
                float: right;
                text-align: left;
                
                font-family: Arial;
            }
            
            .MenuTitle
            {
                width:128px;
                height: 32px;
                
                text-align: left;
                font-size: 20px;
                
                color: #2E2E2E;
                
                border-right: 1px solid #DDDDDD;
            }
            
            .Category
            {
                width:128px;
                height: 32px;
                
                text-align: left;
                font-size: 20px;
                color: #4183C4;
                
                border-bottom: 1px solid #DDDDDD;
                border-top: 1px solid #DDDDDD;
            }
            
            .MenuButton
            {
                width:128px;
                height: 32px;
                
                text-align: left;
                font-size: 18px;
                color: #2E2E2E;
                
                border-right: 1px solid #DDDDDD;
            }
            
            .line
            {
                width: 432px;
                height: 32px;
                
                font-size: 18px;
                color: #000000;
            }
            
            #line0
            {
                width: 432px;
            }
            
            .lineNumber
            {
                width: 32px;
                height: 32px;
                
                float: left;
            }
            
            .lineText
            {
                width: 400px;
                height: 32px;
                
                float: right;
                
                text-align: left;
            }
        </style>
        <link href="../css/Global.css" rel="stylesheet" type="text/css">
    </head>
    <body>
        <div id="header" class="PageColumn">
            <div class="MiddleArea">
                <table id="headerTable">
                    <tr>
                        <td id="systemBrand"  class="Clickable">
                            <font>Marktogether</font>
                        </td>
                        <td id="usrAvator"  class="Clickable">
                        </td>
                        <td id="usrName"  class="Clickable">
                            <font></font>
                        </td>
                        <td id="notifacations"  class="UserCtrlButton Clickable">
                            <font>Notifications</font>
                        </td>
                        <td id="exit"  class="UserCtrlButton Clickable">
                            <font>Exit</font>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <div id="projectHeader" class="PageColumn">
            <div id="projectHeaderMiddle" class="MiddleArea">
                <table id="projectHeaderTable">
                    <tr>
                        <td id="projectIcon" class="ProjectHeaderColumn ClickAble">
                        </td>
                        <td id="projectName" class="ProjectHeaderColumn ClickAble">
                            <font></font>
                        </td>
                        <td id="documentName" class="ProjectHeaderColumn ClickAble">
                            <font></font>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <!--<div class="PageColumn">
            <div id="toolBoxMiddle" class="MiddleArea">
                <table id="toolBoxTable">
                    <tr>
                        <td class="Tool">
                            <div class="ToolIcon ClickAble">
                        </td>
                    </tr>
                </table>
            </div>
        </div>-->
        <!--
        #menu：含有编辑选项
        
        #save：存档当期文本
        #abandon：放弃修改，退出
        #revert：撤销
        #redo：重做

        #editorBody编辑器
        
        #editPannel：编辑框，暂时使用textarea =3=
        #liveView：实时预览框，当编辑框有输入事件时即更新
        -->
        <div id="editor" class="PageColumn">
            <div class="MiddleArea">
                <div id="menu">
                    <div class="Category">
                        <font>>>Document</font>
                    </div>
                    <div id="save" class="MenuButton ClickAble">
                        <font>Save</font>
                    </div>
                    <div id="abandon" class="MenuButton ClickAble">
                        <font>Abandon</font>
                    </div>
                    <div class="Category">
                        <font>>>Editing</font>
                    </div>
                    <div id="revert" class="MenuButton ClickAble">
                        <font>Revert</font>
                    </div>
                    <div id="redo" class="MenuButton ClickAble">
                        <font>Redo</font>
                    </div>
                </div>
                <div id="editorBody">
                    <div id="editPannel">
                        <textarea id="editPane">
                        </textarea>
                    </div>
                    <div id="liveView">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
<script src="../js/jquery-1.11.1.js">
</script>
<script src="../js/Global.js">
</script>
<script src="../js/MarkdownProcessor_by_Showdown.js">
</script>
<script>
    var editPane;
    var liveViewPane;
    
    var saveButton;
    var abandonButtion;
    var revertButton;
    var redoButton;
    //页面元素声明
    
    var inputCache=new Array();
    var textStatus=new Array();
    var reverted=new Array();
    //关于撤销和重做的栈
    //inputCache：在还行之前储存的当前内容，每有输入动作即压栈
    //textStatus：每换行将当前文本压栈
    //reverted：每撤销一次即压栈，重做时退栈

    var converter=new Showdown.converter();
    //markdown解析器
    
    var autoSaveTime=60000;
    var maxResponceDelay=3000;
    
    window.onload=initilize;
    
    function initilize()
    {   
        editPane=document.getElementById("editPane");
        liveViewPane=document.getElementById("liveView");
        saveButton=document.getElementById("save");
        abandonButton=document.getElementById("abandon");
        revertButton=document.getElementById("revert");
        redoButton=document.getElementById("redo");
        //页面元素对应dom
        
        $(saveButton).click(function(){
            onSave();
        });
        $(abandonButton).click(function(){
            onAbandon();
        });
        $(revertButton).click(function(){
            onRevert();
        });
        $(redoButton).click(function(){
            onRedo();
        });
        
        $(editPane).mousedown(function(event){
            onKeyDown(event);
        });
        $(editPane).keydown(function(event){
            onKeyDown(event);
        });
        
        $(editPane).keyup(function(event){
            onEditDoc(event);
        });
        $(document).mouseover(function(event){
            onEditDoc(event);
        });
        //利用jQuery注册事件
        
        editPane.value="#Edit Here";
        convertToLiveView();
        //页面初始化工作
    }

    function preprocessDoc()
    {
        var text=editPane.value;
        return text;
    }

    function convertToLiveView()
    {
        var afterPreprocess=preprocessDoc();
        liveViewPane.innerHTML=converter.makeHtml(afterPreprocess);
    }
    
    function onKeyDown(event)
    {
        switch(event.which)
        {
        case 13:
            textStatus.push(editPane.value);
            inputCache=new Array();
            break;
        default:
            var last="";
            if(inputCache.length!=0)
            {
                last=inputCache[inputCache.length-1];
            }
            else
            {
                if(textStatus.length!=0)
                {
                    last=textStatus[textStatus.length-1];
                }
            }
            if(editPane.value!=last)
            {
                inputCache.push(editPane.value);
            }
            break;
        }
    }
    
    function onEditDoc()
    {
        editPane.style.height=editPane.scrollHeight+'px';
        convertToLiveView();
    }
    
    function onSave()
    {
        alert("save");
    }
    
    function onAbandon()
    {
        alert("abandon");
    }
    
    function onRevert()
    {
        if(inputCache.length!=0)
        {
            reverted.push(editPane.value);
            var text=inputCache.pop();
            editPane.value=text;
        }
        else
        {
            if(textStatus.length!=0)
            {
                reverted.push(editPane.value);
                var text=textStatus.pop();
                editPane.value=text;
            }
        }
        convertToLiveView();
    }
    
    function onRedo()
    {
        if(reverted.length!=0)
        {
            inputCache.push(editPane.value);
            var text=reverted.pop();
            editPane.value=text;
        }
        convertToLiveView();
    }
</script>