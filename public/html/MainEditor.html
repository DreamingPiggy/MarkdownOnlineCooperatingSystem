<!--
编辑器页面
-->
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Editor</title>
        <style>
            #toolBoxMiddle
            {
                height: 64px;
                
                box-shadow: 0 0 1px #DDDDDD;
                border-top: 1px solid #DDDDDD;
                border-left: 1px solid #DDDDDD;
                border-right: 1px solid #DDDDDD;
                border-bottom: 2px solid #4183C4;
                
                border-radius: 4px;
                
                margin-top: 8px;
                margin-bottom: 8px;
            }
            
            table#toolBoxTable
            {
                padding-top: 12px;
            }
            
            table#toolBoxTable td.Tool
            {
                width: 32px;
                height: 32px;
                
                padding-left: 16px;
                padding-right: 16px;
            }
            
            .ToolIcon
            {
                width: 32px;
                height: 32px;
                
                background-size: 32px, 32px;
                background-repeat: no-repeat;
            }
            
            #menu
            {
                width: 128px;
                min-height: 32px;
                
                margin-right: 8px;
                
                float: left;
            }
            
            #editorBody
            {
                width: 872px;
                
                float: right;
            }
            
            #editPannel
            {
                width: 432px;
                min-height: 32px;
                
                margin-right: 8px;
                
                border-right: 1px solid #DDDDDD;
                
                float: left;
            }
            
            #editPane
            {
                width: inherit;
                min-height: 32px;
                resize :none;
                
                text-align: left;
                border: none;
                
                font-family: Arial;
                
                overflow-y: hidden;
                overflow-x: hidden;
            }
            
            #liveView
            {
                width: 430px;
                min-height: 32px;
                
                float: right;
                text-align: left;
                
                font-family: Arial;
            }
            
            .MenuTitle
            {
                width:128px;
                height: 32px;
                
                text-align: left;
                font-size: 20px;
                
                color: #2E2E2E;
                
                border-right: 1px solid #DDDDDD;
            }
            
            .Category
            {
                width:128px;
                height: 32px;
                
                text-align: left;
                font-size: 20px;
                color: #4183C4;
                
                border-bottom: 1px solid #DDDDDD;
                border-top: 1px solid #DDDDDD;
            }
            
            .MenuButton
            {
                width:128px;
                height: 32px;
                
                text-align: left;
                font-size: 18px;
                color: #2E2E2E;
                
                border-right: 1px solid #DDDDDD;
            }
            
            .line
            {
                width: 432px;
                height: 32px;
                
                font-size: 18px;
                color: #000000;
            }
            
            #line0
            {
                width: 432px;
            }
            
            .lineNumber
            {
                width: 32px;
                height: 32px;
                
                float: left;
            }
            
            .lineText
            {
                width: 400px;
                height: 32px;
                
                float: right;
                
                text-align: left;
            }
        </style>
        <link href="../css/Global.css" rel="stylesheet" type="text/css">
    </head>
    <body>
        <div id="header" class="PageColumn">
            <div class="MiddleArea">
                <table id="headerTable">
                    <tr>
                        <td id="systemBrand"  class="Clickable">
                            <font>Marktogether</font>
                        </td>
                        <td id="usrAvator"  class="Clickable">
                        </td>
                        <td id="usrName"  class="Clickable">
                            <font>TestUser</font>
                        </td>
                        <td id="notifacations"  class="UserCtrlButton Clickable">
                            <font>Notifications</font>
                        </td>
                        <td id="exit"  class="UserCtrlButton Clickable">
                            <font>Exit</font>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <div id="projectHeader" class="PageColumn">
            <div id="projectHeaderMiddle" class="MiddleArea">
                <table id="projectHeaderTable">
                    <tr>
                        <td id="projectIcon" class="ProjectHeaderColumn ClickAble">
                        </td>
                        <td id="projectName" class="ProjectHeaderColumn ClickAble">
                            <font>TestProject</font>
                        </td>
                        <td id="documentName" class="ProjectHeaderColumn ClickAble">
                            <font>/TestDocument</font>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <!--<div class="PageColumn">
            <div id="toolBoxMiddle" class="MiddleArea">
                <table id="toolBoxTable">
                    <tr>
                        <td class="Tool">
                            <div class="ToolIcon ClickAble">
                        </td>
                    </tr>
                </table>
            </div>
        </div>-->
        <div id="editor" class="PageColumn">
            <div class="MiddleArea">
                <div id="menu">
                    <div class="Category">
                        <font>>>Document</font>
                    </div>
                    <div id="save" class="MenuButton ClickAble">
                        <font>Save</font>
                    </div>
                    <div id="abandon" class="MenuButton ClickAble">
                        <font>Abandon</font>
                    </div>
                    <div class="Category">
                        <font>>>Editing</font>
                    </div>
                    <div id="revert" class="MenuButton ClickAble">
                        <font>Revert</font>
                    </div>
                    <div id="redo" class="MenuButton ClickAble">
                        <font>Redo</font>
                    </div>
                </div>
                <div id="editorBody">
                    <div id="editPannel">
                        <textarea id="editPane">
                        </textarea>
                        <!--<div id="line0">
                        </div>-->
                    </div>
                    <div id="liveView">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
<script src="../js/jquery-1.11.1.js">
</script>
<script src="../js/Global.js">
</script>
<script src="../js/MarkdownProcessor_by_Showdown.js">
</script>
<script>
    /*function Line(num)
    {
        this.container=null;
        this.numberDiv=null;
        this.textDiv=null;
        
        this.number=num;
        
        this.display=function(parent)
        {
            this.container=document.createElement("div");
            $(this.container).addClass("line");
            this.numberDiv=document.createElement("div");
            $(this.numberDiv).addClass("lineNumber");
            this.numberDiv.innerHTML="<font>"+this.number+"</font>";
            this.textDiv=document.createElement("div");
            $(this.textDiv).addClass("lineText");
            $(parent).append(this.container);
            $(this.container).append(this.numberDiv);
            $(this.container).append(this.textDiv);
        }
        
        this.startEditing=function()
        {
        }
    }*/
    
    /*function Editor()
    {
        this.lines=new Array();
        this.lines[0]=document.getElementById("line0");
        
        this.addLine=function()
        {
            this.lines[this.lineNumbers]=new Line(this.lines.length);
            this.lines[this.lineNumbers].display(document.getElementById("editPannel"));
        }
    }*/
    
    //var thisEditor=new Editor();
    //thisEditor.addLine();
    
    var editPane;
    var liveViewPane;
    //编辑器及预览窗口
    
    var saveButton;
    var abandonButtion;
    var revertButton;
    var redoButton;
    //页面中按钮
    
    //基本页面元素的声明
    
    var inputCache=new Array();
    var textStatus=new Array();
    var reverted=new Array();

    var converter=new Showdown.converter();
    
    var autoSaveTime=60000;
    var maxResponceDelay=3000;
    
    window.onload=initilizeGUI;
    
    function initilizeGUI()
    {   
        editPane=document.getElementById("editPane");
        liveViewPane=document.getElementById("liveView");
        saveButton=document.getElementById("save");
        abandonButton=document.getElementById("abandon");
        revertButton=document.getElementById("revert");
        redoButton=document.getElementById("redo");
        //页面元素查找相应DOM
        
        $(saveButton).click(function(){
            onSave();
        });
        $(abandonButton).click(function(){
            onAbandon();
        });
        $(revertButton).click(function(){
            onRevert();
        });
        $(redoButton).click(function(){
            onRedo();
        });
        //按钮事件
        
        $(editPane).mousedown(function(event){
            onKeyDown(event);
        });
        $(editPane).keydown(function(event){
            onKeyDown(event);
        });
        
        $(editPane).keyup(function(event){
            onEditDoc(event);
        });
        $(document).mouseover(function(event){
            onEditDoc(event);
        });
        //编辑框输入事件
        
        //设定事件
        
        editPane.value="#Edit Here";
        //textStatus.push(editPane.value);
        convertToLiveView();
        //初始化操作
    }

    function preprocessDoc()
    {
        var text=editPane.value;
        return text;
    }

    function convertToLiveView()
    {
        var afterPreprocess=preprocessDoc();
        liveViewPane.innerHTML=converter.makeHtml(afterPreprocess);
    }
    
    function onKeyDown(event)
    {
        switch(event.which)
        {
        case 13:
            textStatus.push(editPane.value);
            inputCache=new Array();
            break;
        default:
            var last="";
            if(inputCache.length!=0)
            {
                last=inputCache[inputCache.length-1];
            }
            else
            {
                if(textStatus.length!=0)
                {
                    last=textStatus[textStatus.length-1];
                }
            }
            if(editPane.value!=last)
            {
                inputCache.push(editPane.value);
            }
            break;
        }
    }
    
    function onEditDoc()
    {
        editPane.style.height=editPane.scrollHeight+'px';
        convertToLiveView();
    }
    
    function onSave()
    {
    }
    
    function onAbandon()
    {
    }
    
    function onRevert()
    {
        if(inputCache.length!=0)
        {
            reverted.push(editPane.value);
            var text=inputCache.pop();
            editPane.value=text;
        }
        else
        {
            if(textStatus.length!=0)
            {
                reverted.push(editPane.value);
                var text=textStatus.pop();
                editPane.value=text;
            }
        }
        convertToLiveView();
    }
    
    function onRedo()
    {
        if(reverted.length!=0)
        {
            inputCache.push(editPane.value);
            var text=reverted.pop();
            editPane.value=text;
        }
        convertToLiveView();
    }
</script>